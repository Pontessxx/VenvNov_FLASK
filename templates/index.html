<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controle de Presen√ßa</title>
  
  <!-- Estilos externos -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../static/styles.css">
  
  <!-- Scripts externos -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="menu">
      <form id="siteForm" action="/" method="POST">
        <h2>Filtros de Navega√ß√£o</h2>
        <label for="site">Selecione o Site:</label>
        <select id="site" name="site">
          <option value="">-- Escolha um Site --</option>
          {% for site in sites %}
            <option value="{{ site }}" {% if site == selected_site %}selected{% endif %}>
              {{ site }}
            </option>
          {% endfor %}
        </select>
  
        <label for="empresa">Selecione a Empresa:</label>
        <select id="empresa" name="empresa">
          <option value="">-- Escolha uma Empresa --</option>
          {% for empresa in empresas %}
            <option value="{{ empresa }}" {% if empresa == selected_empresa %}selected{% endif %}>
              {{ empresa }}
            </option>
          {% endfor %}
        </select>
      </form>
      <button id="add_presenca" onclick="goToAddPresenca()">Adicionar Presen√ßa</button>
      <button id="toggle-theme">Alternar Tema</button>
  
      <div class="developer-info">
        <p>Developed by 
          <a href="https://www.linkedin.com/in/henrique-pontes-oliveira/" target="_blank">
            Henrique Pontes
          </a>
        </p>
      </div>
    </div>
  
    <div class="main-content">
      <h1>Controle de Presen√ßa</h1>
  
      <div class="filtros">
        <form id="filterForm" action="/" method="POST">
          <input type="hidden" id="hiddenSite" name="site" value="{{ selected_site }}">
          <input type="hidden" id="hiddenEmpresa" name="empresa" value="{{ selected_empresa }}">
        
          <div>
            <label for="nomes">Selecione Nomes:</label>
            <select id="nomes" name="nomes" multiple="multiple">
              {% for nome in nomes %}
                <option value="{{ nome }}" {% if nome in selected_nomes %}selected{% endif %}>
                  {{ nome }}
                </option>
              {% endfor %}
            </select>
          </div>
        
          <div>
            <label for="presenca">Selecione o Tipo de Presen√ßa:</label>
            <select id="presenca" name="presenca" multiple="multiple">
              {% for presenca in presencas %}
                <option value="{{ presenca }}" {% if presenca in selected_presenca %}selected{% endif %}>
                  {{ presenca }}
                </option>
              {% endfor %}
            </select>
          </div>
        
          <div>
            <label for="meses">Selecione o M√™s:</label>
            <select id="meses" name="meses" multiple="multiple">
              {% for mes in meses %}
                <option value="{{ mes }}" {% if mes in selected_meses %}selected{% endif %}>
                  {{ mes }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="ano">Selecione o Ano:</label>
            <select id="ano" name="ano">
              <option value="">-- Escolha um Ano --</option>
              {% for ano in range(2024, 2100) %}
                <option value="{{ ano }}" {% if ano == selected_ano %}selected{% endif %}>
                  {{ ano }}
                </option>
              {% endfor %}
            </select>
          </div>
          
        </form>
      </div>
  
      <div id="table-container">
        {% if data is not none %}
          <table class="content-table">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Presen√ßa</th>
                <th>Data</th>
              </tr>
            </thead>
            <tbody>
              {% for index, row in data.iterrows() %}
                <tr>
                  <td>{{ row['Nome'] }}</td>
                  <td>{{ row['Presenca'] }}</td>
                  <td>{{ row['Data'] }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p>Nenhum dado dispon√≠vel para o filtro selecionado.</p>
        {% endif %}
      </div>
  
      <div class="graficos_cards">
        <div class="legenda_graficos">
          <div>
            <h2>Dias Registrados</h2>
            <span class="numeros">{{ total_dias_registrados }}</span>
          </div>
          <div class="legenda_grafico_span_ok">
            <h2>Total <span>OK</span></h2>
            <span class="numeros">{{ total_ok }}</span>
          </div>
          <div class="legenda_grafico_span_falta">
            <h2>Total <span>FALTAS</span></h2>
            <span class="numeros">{{ total_faltas }}</span>
          </div>
          <div class="legenda_grafico_span_atestado">
            <h2>Total <span>ATESTADOS</span></h2>
            <span class="numeros">{{ total_atestados }}</span>
          </div>
        </div>
        
        <div class="graficos">
          <div class="grafico_um">
            <div id="pie-chart"></div>
          </div>
          <div class="grafico_dois">
            <div id="stacked-bar-chart"></div>
          </div>
        </div>                
        
        <div>
          <div id="scatter-chart"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Bot√£o para abrir o chat -->
    <div id="chat-button" onclick="toggleChat()">üí¨ Chat</div>

    <!-- Overlay que cobre toda a tela -->
    <div id="chat-overlay">
    <!-- Pop-up do Chat, centralizado dentro do overlay -->
    <div id="chat-popup">
        <div id="chat-header">
            <span>Chatbot</span>
            <button id="chat-close" onclick="toggleChat()">‚ùå</button>
        </div>
        <div id="chat-messages"></div>
        <div id="chat-input-area">
            <input type="text" id="chat-input" placeholder="Digite sua mensagem..." onkeypress="handleKeyPress(event)">
            <button id="send-chat" onclick="sendMessage()">Enviar</button>
            <!-- Bot√£o de limpar o chat (√≠cone de reload) -->
            <button id="clear-chat" onclick="clearChat()" title="Limpar Chat">&#x21bb;</button>
        </div>
    </div>
    </div>

  
  <script>
    $(document).ready(function () {
      $('#nomes').select2({ placeholder: "Escolha um nome" });
      $('#meses').select2({ placeholder: "Escolha um m√™s" });
      $('#presenca').select2({ placeholder: "Escolha uma presen√ßa" });
  
      function submitWithSiteEmpresa() {
        const site = $('#site').val();
        const empresa = $('#empresa').val();
        $('#hiddenSite').val(site);
        $('#hiddenEmpresa').val(empresa);
        $('#filterForm').submit();
      }
  
      $('#nomes, #meses, #presenca, #ano').on('change', function () {
        submitWithSiteEmpresa();
      });
  
      $('#site, #empresa').on('change', function () {
        $('#siteForm').submit();
      });
  
      function goToAddPresenca() {
        window.location.href = "/adicionar-presenca";
      }
      window.goToAddPresenca = goToAddPresenca;

    });
    $(document).ready(function () {
      // Fun√ß√£o para atualizar as cores dos gr√°ficos com base no tema
      function updateChartColors(theme) {
        let textColor = theme === 'dark-mode' ? '#ffffff' : '#000000';
        if (
          document.getElementById('stacked-bar-chart') &&
          document.getElementById('scatter-chart') &&
          document.getElementById('pie-chart')
        ) {
          Plotly.relayout('stacked-bar-chart', { 'font.color': textColor });
          Plotly.relayout('scatter-chart', { 'font.color': textColor });
          Plotly.relayout('pie-chart', { 'font.color': textColor });
        }
      }
  
      // Aplica o tema salvo no localStorage
      (function () {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
          document.body.classList.add(savedTheme);
        } else {
          localStorage.setItem('theme', 'light-mode');
        }
      })();
  
      // Renderiza os gr√°ficos
      var stackedBarChartData = {{ stacked_bar_chart_data | safe }};
      var scatterChartData = {{ scatter_chart_data | safe }};
      var pieChartData = {{ pie_chart_data | safe }};
  
      Plotly.newPlot('stacked-bar-chart', stackedBarChartData.data, stackedBarChartData.layout)
        .then(function () {
          const currentTheme = localStorage.getItem('theme') || 'light-mode';
          updateChartColors(currentTheme);
        });
  
      Plotly.newPlot('scatter-chart', scatterChartData.data, scatterChartData.layout)
        .then(function () {
          const currentTheme = localStorage.getItem('theme') || 'light-mode';
          updateChartColors(currentTheme);
        });
  
      Plotly.newPlot('pie-chart', pieChartData.data, pieChartData.layout)
        .then(function () {
          const currentTheme = localStorage.getItem('theme') || 'light-mode';
          updateChartColors(currentTheme);
        });
  
      $('#toggle-theme').on('click', function () {
        document.body.classList.toggle('dark-mode');
        const currentTheme = document.body.classList.contains('dark-mode') ? 'dark-mode' : 'light-mode';
        localStorage.setItem('theme', currentTheme);
        updateChartColors(currentTheme);
      });
  
      // Fun√ß√£o para capturar a largura da tela e armazenar no sessionStorage
      function salvarLarguraTela() {
          const screenWidth = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
          sessionStorage.setItem('screenWidth', screenWidth);
      }

      // Chama a fun√ß√£o ao carregar a p√°gina
      document.addEventListener("DOMContentLoaded", function() {
          salvarLarguraTela();
      });
  
      // --- Fun√ß√µes do Chat com persist√™ncia de hist√≥rico ---
  
      function loadChatHistory() {
        var storedHistory = localStorage.getItem('chatHistory');
        if (storedHistory) {
          document.getElementById('chat-messages').innerHTML = storedHistory;
        }
      }
  
      function saveChatHistory() {
        var chatContent = document.getElementById('chat-messages').innerHTML;
        localStorage.setItem('chatHistory', chatContent);
      }
  
      function clearChat() {
        document.getElementById('chat-messages').innerHTML = "";
        localStorage.removeItem('chatHistory');
      }
      window.clearChat = clearChat;
  
      function toggleChat() {
        var chatOverlay = document.getElementById("chat-overlay");
        var chatMessages = document.getElementById("chat-messages");

        if (chatOverlay.style.display === "none" || chatOverlay.style.display === "") {
            chatOverlay.style.display = "block";

            // Se o chat est√° sendo aberto pela primeira vez na sess√£o, exibir mensagens de boas-vindas
            if (!sessionStorage.getItem("chatOpened")) {
                chatMessages.innerHTML = ""; // Limpa mensagens antigas antes de exibir as sauda√ß√µes

                var botDiv1 = document.createElement("div");
                botDiv1.classList.add("chat-message", "bot");
                botDiv1.textContent = "Bem-vindo ao chatbot! Envie uma mensagem para come√ßar.";

                var botDiv2 = document.createElement("div");
                botDiv2.classList.add("chat-message", "bot");
                botDiv2.textContent = "Se precisar de ajuda, basta perguntar!";

                chatMessages.appendChild(botDiv1);
                chatMessages.appendChild(botDiv2);

                sessionStorage.setItem("chatOpened", "true"); // Marca que o chat foi aberto
                saveChatHistory();
            } else {
                // Carregar hist√≥rico do chat caso j√° tenha sido aberto antes
                loadChatHistory();
            }
        } else {
            chatOverlay.style.display = "none";
            sessionStorage.removeItem("chatOpened"); // Remove a marca√ß√£o ao fechar o chat
        }
    }



      window.toggleChat = toggleChat;
  
      function handleKeyPress(event) {
        if (event.key === "Enter") {
          sendMessage();
        }
      }
      window.handleKeyPress = handleKeyPress;
  
      function sendMessage() {
    var inputField = document.getElementById("chat-input");
    var userMessage = inputField.value.trim();
    if (userMessage === "") return;

    var chatMessages = document.getElementById("chat-messages");

    // Cria e adiciona o elemento para a mensagem do usu√°rio
    var userDiv = document.createElement("div");
    userDiv.classList.add("chat-message", "user");
    userDiv.textContent = userMessage;
    chatMessages.appendChild(userDiv);
    saveChatHistory();

    // Envia a mensagem para o backend (rota /chatbot)
    fetch("/chatbot", {
        method: "POST",
        body: JSON.stringify({ mensagem: userMessage }),
        headers: { "Content-Type": "application/json" }
    })
    .then(response => response.json())
    .then(data => {
        if (data.respostas) {
            data.respostas.forEach(function(resp) {
                var botDiv = document.createElement("div");
                botDiv.classList.add("chat-message", "bot");
                // Se o tipo for "table", insere como HTML para renderizar a tabela;
                // caso contr√°rio, insere como texto.
                if (resp.tipo === "table") {
                    botDiv.innerHTML = resp.mensagem;
                } else {
                    botDiv.textContent = resp.mensagem;
                }
                chatMessages.appendChild(botDiv);
            });
        }
        chatMessages.scrollTop = chatMessages.scrollHeight;
        saveChatHistory();
    })
    .catch(error => console.error("Erro ao enviar mensagem:", error));

    inputField.value = "";
}


      window.sendMessage = sendMessage;
  
      loadChatHistory();
    });
  </script>
</body>
</html>
